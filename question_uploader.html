<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Instructor Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        select, input, textarea, button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            max-width: 500px;
        }

        label {
            font-weight: bold;
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .question-form {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
        }

        .option-input {
            margin-left: 20px;
        }
    </style>
</head>
<body>

<h2>Instructor Question Uploader</h2>

<label for="courseSelect">Select Course:</label>
<select id="courseSelect">
    <option value="">-- Select --</option>
</select>

<label for="conceptSelect">Select Concept or Add New:</label>
<select id="conceptSelect">
    <option value="">-- Select Existing --</option>
</select>
<input type="text" id="newConceptInput" placeholder="Or type new concept name" />

<div class="question-form">
    <label for="typeSelect">Question Type:</label>
    <select id="typeSelect">
        <option value="MCQ">MCQ</option>
        <option value="TF">True / False</option>
    </select>

    <label for="questionInput">Question (EN / AR):</label>
    <textarea id="questionInput" rows="3" placeholder="Write your question here..."></textarea>

    <div id="mcqOptions">
        <label>Options (EN / AR):</label>
        <input class="option-input" type="text" placeholder="Option 1" />
        <input class="option-input" type="text" placeholder="Option 2" />
        <input class="option-input" type="text" placeholder="Option 3" />
        <input class="option-input" type="text" placeholder="Option 4" />
        <label>Correct Answer (must match one option exactly):</label>
        <input id="mcqAnswer" type="text" />
    </div>

    <div id="tfAnswer" class="hidden">
        <label>Correct Answer:</label>
        <select>
            <option value="true">True</option>
            <option value="false">False</option>
        </select>
    </div>

    <button onclick="submitQuestion()">Submit Question</button>
</div>

<script>
    const coursesUrl = 'courses/courses.json';
    let existingQuestions = [];

    // Load courses
    fetch(coursesUrl)
        .then(res => res.json())
        .then(data => {
            const courseSelect = document.getElementById('courseSelect');
            for (let course in data) {
                const opt = document.createElement('option');
                opt.value = course;
                opt.textContent = course;
                courseSelect.appendChild(opt);
            }
        });

    // Load concepts on course select
    document.getElementById('courseSelect').addEventListener('change', async () => {
        const course = document.getElementById('courseSelect').value;
        const conceptSelect = document.getElementById('conceptSelect');
        conceptSelect.innerHTML = '<option value="">-- Select Existing --</option>';

        const res = await fetch(coursesUrl);
        const data = await res.json();
        const concepts = data[course] || [];
        concepts.forEach(con => {
            const opt = document.createElement('option');
            opt.value = con;
            opt.textContent = con.replaceAll('_', ' ');
            conceptSelect.appendChild(opt);
        });
    });

    // Show/hide based on question type
    document.getElementById('typeSelect').addEventListener('change', () => {
        const type = document.getElementById('typeSelect').value;
        document.getElementById('mcqOptions').style.display = (type === 'MCQ') ? 'block' : 'none';
        document.getElementById('tfAnswer').classList.toggle('hidden', type !== 'TF');
    });

    async function submitQuestion() {
        const course = document.getElementById('courseSelect').value;
        const conceptDropdown = document.getElementById('conceptSelect').value;
        const newConcept = document.getElementById('newConceptInput').value.trim().replaceAll(' ', '_');
        const concept = newConcept || conceptDropdown;

        if (!course || !concept) {
            alert("Please select a course and enter/select a concept.");
            return;
        }

        const type = document.getElementById('typeSelect').value;
        const questionText = document.getElementById('questionInput').value.trim();
        if (!questionText) return alert("Question cannot be empty");

        let newQ = { type, question: questionText };

        if (type === 'MCQ') {
            const options = [...document.querySelectorAll('.option-input')].map(input => input.value.trim()).filter(v => v);
            const answer = document.getElementById('mcqAnswer').value.trim();
            if (options.length !== 4 || !answer || !options.includes(answer)) {
                return alert("Enter 4 options and a valid answer matching one of them.");
            }
            newQ.options = options;
            newQ.answer = answer;
        } else {
            const tfAns = document.querySelector('#tfAnswer select').value;
            newQ.answer = tfAns;
        }

        // Load existing questions (try fetch, fallback to empty)
        try {
            const res = await fetch(`questions/${course}/${concept}.json`);
            if (res.ok) {
                existingQuestions = await res.json();
            } else {
                existingQuestions = [];
            }
        } catch {
            existingQuestions = [];
        }

        // Add and download
        existingQuestions.push(newQ);
        downloadJSON(existingQuestions, `${concept}.json`);
        alert("Question added successfully (downloaded for now)");
    }

    function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.download = filename;
        link.href = URL.createObjectURL(blob);
        link.click();
    }
</script>

</body>
</html>
