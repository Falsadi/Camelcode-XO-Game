<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Instructor Question Uploader</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .hidden { display: none; }
        select, input, textarea, button {
            margin: 10px 0; padding: 8px; width: 100%; max-width: 500px;
        }
        .question-form, .json-form {
            border: 1px solid #ddd; padding: 15px; margin-top: 20px; border-radius: 8px;
        }
        label { font-weight: bold; margin-top: 10px; display: block; }
    </style>
</head>
<body>

<h2>Instructor Question Uploader</h2>

<label>How would you like to add questions?</label>
<button onclick="showForm('builder')">Use Form (recommended)</button>
<button onclick="showForm('json')">Paste JSON Directly</button>

<div id="form-section" class="hidden">
    <!-- Form input version -->
    <div class="question-form" id="builder-form">
        <label for="courseSelect">Select Course:</label>
        <select id="courseSelect"><option value="">-- Select --</option></select>

        <label for="conceptSelect">Select Concept or Add New:</label>
        <select id="conceptSelect"><option value="">-- Select Existing --</option></select>
        <input type="text" id="newConceptInput" placeholder="Or type new concept name" />

        <label for="typeSelect">Question Type:</label>
        <select id="typeSelect">
            <option value="MCQ">MCQ</option>
            <option value="TF">True / False</option>
        </select>

        <label for="questionInput">Question (EN / AR):</label>
        <textarea id="questionInput" rows="3"></textarea>

        <div id="mcqOptions">
            <label>Options:</label>
            <input class="option-input" placeholder="Option 1" />
            <input class="option-input" placeholder="Option 2" />
            <input class="option-input" placeholder="Option 3" />
            <input class="option-input" placeholder="Option 4" />
            <label>Correct Answer:</label>
            <input id="mcqAnswer" />
        </div>

        <div id="tfAnswer" class="hidden">
            <label>Correct Answer:</label>
            <select><option value="true">True</option><option value="false">False</option></select>
        </div>

        <button onclick="submitQuestion()">Submit Question</button>
    </div>

    <!-- JSON input version -->
    <div class="json-form hidden" id="json-form">
        <label for="jsonCourseSelect">Select Course:</label>
        <select id="jsonCourseSelect"><option value="">-- Select Course --</option></select>

        <label for="jsonConceptSelect">Select Existing Concept:</label>
        <select id="jsonConceptSelect"><option value="">-- Select Existing --</option></select>

        <label for="jsonNewConcept">Or type new concept name:</label>
        <input id="jsonNewConcept" placeholder="new_concept_name" />

        <label>Paste JSON Array of Questions:</label>
        <textarea id="jsonInput" rows="10" placeholder='[ { "type": "TF", ... }, ... ]'></textarea>

        <button onclick="submitJson()">Download JSON File</button>
    </div>
</div>

<script>
    const coursesUrl = 'courses/courses.json';

    function showForm(mode) {
        document.getElementById('form-section').classList.remove('hidden');
        document.getElementById('builder-form').classList.toggle('hidden', mode !== 'builder');
        document.getElementById('json-form').classList.toggle('hidden', mode !== 'json');
        loadCourses(mode);
    }

    async function loadCourses(mode) {
        const res = await fetch(coursesUrl);
        const data = await res.json();

        if (mode === 'builder') {
            const courseSelect = document.getElementById('courseSelect');
            courseSelect.innerHTML = '<option value="">-- Select --</option>';
            for (let course in data) {
                const opt = document.createElement('option');
                opt.value = course;
                opt.textContent = course;
                courseSelect.appendChild(opt);
            }

            courseSelect.onchange = () => {
                const conceptSelect = document.getElementById('conceptSelect');
                conceptSelect.innerHTML = '<option value="">-- Select Existing --</option>';
                const concepts = data[courseSelect.value] || [];
                concepts.forEach(con => {
                    const opt = document.createElement('option');
                    opt.value = con;
                    opt.textContent = con.replaceAll('_', ' ');
                    conceptSelect.appendChild(opt);
                });
            };
        }

        if (mode === 'json') {
            const jsonCourseSelect = document.getElementById('jsonCourseSelect');
            jsonCourseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            for (let course in data) {
                const opt = document.createElement('option');
                opt.value = course;
                opt.textContent = course;
                jsonCourseSelect.appendChild(opt);
            }

            jsonCourseSelect.onchange = () => {
                const conceptSelect = document.getElementById('jsonConceptSelect');
                conceptSelect.innerHTML = '<option value="">-- Select Existing --</option>';
                const concepts = data[jsonCourseSelect.value] || [];
                concepts.forEach(con => {
                    const opt = document.createElement('option');
                    opt.value = con;
                    opt.textContent = con.replaceAll('_', ' ');
                    conceptSelect.appendChild(opt);
                });
            };
        }
    }

    document.getElementById('typeSelect').onchange = () => {
        const type = document.getElementById('typeSelect').value;
        document.getElementById('mcqOptions').style.display = (type === 'MCQ') ? 'block' : 'none';
        document.getElementById('tfAnswer').classList.toggle('hidden', type !== 'TF');
    };

    function submitQuestion() {
        const course = document.getElementById('courseSelect').value;
        const concept = document.getElementById('newConceptInput').value.trim().replaceAll(' ', '_') || document.getElementById('conceptSelect').value;
        const type = document.getElementById('typeSelect').value;
        const questionText = document.getElementById('questionInput').value.trim();

        if (!course || !concept || !questionText) return alert("All fields required.");

        let question = { type, question: questionText };

        if (type === 'MCQ') {
            const options = [...document.querySelectorAll('.option-input')].map(i => i.value.trim()).filter(v => v);
            const answer = document.getElementById('mcqAnswer').value.trim();
            if (options.length !== 4 || !options.includes(answer)) return alert("Enter 4 options and valid answer.");
            question.options = options;
            question.answer = answer;
        } else {
            question.answer = document.querySelector('#tfAnswer select').value;
        }

        downloadJSON([question], `${concept}.json`);
    }

    function submitJson() {
        const course = document.getElementById('jsonCourseSelect').value;
        const concept = document.getElementById('jsonNewConcept').value.trim().replaceAll(' ', '_') || document.getElementById('jsonConceptSelect').value;
        const input = document.getElementById('jsonInput').value.trim();

        if (!course || !concept || !input) return alert("Please select course, concept, and enter JSON.");

        try {
            const parsed = JSON.parse(input);
            if (!Array.isArray(parsed)) throw new Error();
            downloadJSON(parsed, `${concept}.json`);
        } catch {
            alert("Invalid JSON format. Must be an array of question objects.");
        }
    }

    function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.download = filename;
        link.href = URL.createObjectURL(blob);
        link.click();
    }
</script>

</body>
</html>
